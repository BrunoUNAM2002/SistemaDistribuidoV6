{% extends "base.html" %}

{% block title %}Crear Visita de Emergencia{% endblock %}

{% block content %}
<!-- Page Header -->
<div class="d-flex justify-content-between align-items-center mb-4">
    <div>
        <h2 style="font-weight: 700; color: var(--text-primary); margin-bottom: 0.5rem;">
            <i class="bi bi-plus-circle-fill me-2" style="color: var(--primary);"></i>Nueva Visita
        </h2>
        <p style="color: var(--text-secondary); margin: 0;">
            Registrar visita de emergencia - Sala {{ node_id }}
        </p>
    </div>
    <a href="{{ url_for('dashboard') }}" class="btn-modern" style="background: var(--bg-tertiary); color: var(--text-primary); border: 1px solid var(--border-color);">
        <i class="bi bi-arrow-left"></i> Volver
    </a>
</div>

<div class="row">
    <div class="col-12 col-xl-10 mx-auto">
        <div class="card-modern">
            <div style="padding: 2rem;">
                <form method="POST" action="{{ url_for('visitas.crear_visita') }}" id="crear-visita-form">
                    <!-- Datos del Paciente -->
                    <div style="background: var(--bg-secondary); padding: 1.5rem; border-radius: var(--radius-lg); margin-bottom: 2rem; border-left: 4px solid var(--primary);">
                        <h5 style="margin-bottom: 1.5rem; font-weight: 600; color: var(--text-primary);">
                            <i class="bi bi-person-fill me-2" style="color: var(--primary);"></i>Datos del Paciente
                        </h5>

                        <div class="row g-3">
                            <div class="col-md-6">
                                <div class="form-floating-modern">
                                    <input type="text" class="form-control-modern" id="nombre" name="nombre" placeholder="Nombre completo" required>
                                    <label><i class="bi bi-person me-2"></i>Nombre Completo <span class="text-danger">*</span></label>
                                </div>
                            </div>

                            <div class="col-md-3">
                                <div class="form-floating-modern">
                                    <input type="number" class="form-control-modern" id="edad" name="edad" min="0" max="120" placeholder="Edad" required>
                                    <label><i class="bi bi-calendar me-2"></i>Edad <span class="text-danger">*</span></label>
                                </div>
                            </div>

                            <div class="col-md-3">
                                <div class="form-floating-modern">
                                    <select class="form-control-modern" id="sexo" name="sexo" required>
                                        <option value="">Seleccione...</option>
                                        <option value="M">Masculino</option>
                                        <option value="F">Femenino</option>
                                    </select>
                                    <label><i class="bi bi-gender-ambiguous me-2"></i>Sexo <span class="text-danger">*</span></label>
                                </div>
                            </div>

                            <div class="col-md-6">
                                <div class="form-floating-modern">
                                    <input type="text" class="form-control-modern" id="curp" name="curp" maxlength="18"
                                           pattern="[A-Z]{4}[0-9]{6}[HM][A-Z]{5}[0-9A-Z]{2}"
                                           placeholder="AAAA000000HAAAAA00">
                                    <label><i class="bi bi-card-text me-2"></i>CURP (Opcional)</label>
                                </div>
                                <small style="color: var(--text-tertiary); font-size: 0.875rem; margin-top: 0.25rem; display: block;">
                                    18 caracteres - Opcional
                                </small>
                            </div>

                            <div class="col-md-6">
                                <div class="form-floating-modern">
                                    <input type="tel" class="form-control-modern" id="telefono" name="telefono" placeholder="Teléfono">
                                    <label><i class="bi bi-telephone me-2"></i>Teléfono</label>
                                </div>
                            </div>

                            <div class="col-12">
                                <div class="form-floating-modern">
                                    <input type="text" class="form-control-modern" id="contacto_emergencia" name="contacto_emergencia"
                                           placeholder="Nombre y teléfono del familiar">
                                    <label><i class="bi bi-person-lines-fill me-2"></i>Contacto de Emergencia</label>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Síntomas -->
                    <div style="background: var(--bg-secondary); padding: 1.5rem; border-radius: var(--radius-lg); margin-bottom: 2rem; border-left: 4px solid var(--success);">
                        <h5 style="margin-bottom: 1.5rem; font-weight: 600; color: var(--text-primary);">
                            <i class="bi bi-clipboard-pulse me-2" style="color: var(--success);"></i>Información de la Visita
                        </h5>

                        <div class="form-floating-modern">
                            <textarea class="form-control-modern" id="sintomas" name="sintomas" rows="4"
                                      placeholder="Describa los síntomas o motivo de la visita de emergencia..."
                                      style="min-height: 120px;" required></textarea>
                            <label><i class="bi bi-file-text me-2"></i>Síntomas / Motivo de Consulta <span class="text-danger">*</span></label>
                        </div>
                    </div>

                    <!-- Asignación de Recursos -->
                    <div style="background: var(--bg-secondary); padding: 1.5rem; border-radius: var(--radius-lg); margin-bottom: 2rem; border-left: 4px solid var(--info);">
                        <h5 style="margin-bottom: 1.5rem; font-weight: 600; color: var(--text-primary);">
                            <i class="bi bi-diagram-3-fill me-2" style="color: var(--info);"></i>Asignación de Recursos
                        </h5>

                        <div style="background: rgba(6, 182, 212, 0.1); border: 1px solid rgba(6, 182, 212, 0.3); padding: 1rem; border-radius: var(--radius-md); margin-bottom: 1.5rem;" id="recursos-alert">
                            <div style="display: flex; align-items: center; gap: 0.5rem;">
                                <i class="bi bi-info-circle-fill" style="color: var(--info);"></i>
                                <span style="color: var(--text-primary); font-weight: 500;">Recursos disponibles:</span>
                                <span id="recursos-info" style="color: var(--text-secondary);">{{ doctores|length }} doctores, {{ camas|length }} camas</span>
                            </div>
                        </div>

                        <div class="row g-3">
                            <div class="col-md-6">
                                <div class="form-floating-modern">
                                    <select class="form-control-modern" id="id_doctor" name="id_doctor" required>
                                        <option value="">Seleccione un doctor...</option>
                                        {% for doctor in doctores %}
                                        <option value="{{ doctor.id_doctor }}">
                                            Dr. {{ doctor.nombre }} - {{ doctor.especialidad }}
                                        </option>
                                        {% endfor %}
                                    </select>
                                    <label><i class="bi bi-person-badge me-2"></i>Doctor <span class="text-danger">*</span></label>
                                </div>
                                <small style="color: var(--text-tertiary); font-size: 0.875rem; margin-top: 0.25rem; display: block;">
                                    Solo se muestran doctores disponibles
                                </small>
                            </div>

                            <div class="col-md-6">
                                <div class="form-floating-modern">
                                    <select class="form-control-modern" id="id_cama" name="id_cama" required>
                                        <option value="">Seleccione una cama...</option>
                                        {% for cama in camas %}
                                        <option value="{{ cama.id_cama }}">
                                            Cama {{ cama.numero }} - Sala {{ cama.id_sala }}
                                        </option>
                                        {% endfor %}
                                    </select>
                                    <label><i class="bi bi-hospital me-2"></i>Cama <span class="text-danger">*</span></label>
                                </div>
                                <small style="color: var(--text-tertiary); font-size: 0.875rem; margin-top: 0.25rem; display: block;">
                                    Solo se muestran camas disponibles
                                </small>
                            </div>
                        </div>

                        {% if not doctores or not camas %}
                        <div style="background: rgba(245, 158, 11, 0.1); border: 1px solid rgba(245, 158, 11, 0.3); padding: 1rem; border-radius: var(--radius-md); margin-top: 1rem;">
                            <div style="display: flex; align-items: center; gap: 0.5rem;">
                                <i class="bi bi-exclamation-triangle-fill" style="color: var(--warning);"></i>
                                <div>
                                    <strong>Atención:</strong>
                                    {% if not doctores %}
                                        No hay doctores disponibles en este momento.
                                    {% elif not camas %}
                                        No hay camas disponibles en este momento.
                                    {% endif %}
                                    Por favor, espere o intente más tarde.
                                </div>
                            </div>
                        </div>
                        {% endif %}
                    </div>

                    <!-- Botones -->
                    <div style="display: flex; justify-content: space-between; align-items: center; gap: 1rem; flex-wrap: wrap;">
                        <button type="button" class="btn-modern" style="background: var(--bg-tertiary); color: var(--text-primary); border: 1px solid var(--border-color);" onclick="refreshRecursos()">
                            <i class="bi bi-arrow-clockwise"></i> Actualizar Recursos
                        </button>
                        <button type="submit" class="btn-modern btn-gradient"
                                {% if not doctores or not camas %}disabled{% endif %}
                                style="min-width: 200px;">
                            <i class="bi bi-check-circle"></i> Crear Visita
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="{{ url_for('static', filename='js/visitas.js') }}"></script>
{% endblock %}
