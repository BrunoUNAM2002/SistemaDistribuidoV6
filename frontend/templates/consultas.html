{% extends "base.html" %}

{% block title %}Consultas Globales{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <h2 class="mb-4"><i class="bi bi-table"></i> Consultas Globales del Sistema</h2>

        <!-- Filtros -->
        <div class="card mb-3">
            <div class="card-body">
                <form method="GET" action="{{ url_for('consultas.global_view') }}" class="row g-3">
                    <div class="col-md-4">
                        <label for="sala" class="form-label">Filtrar por Sala</label>
                        <select class="form-select" id="sala" name="sala" onchange="this.form.submit()">
                            <option value="">Todas las salas</option>
                            {% for sala in salas %}
                            <option value="{{ sala.id_sala }}" {% if filtro_sala == sala.id_sala %}selected{% endif %}>
                                Sala {{ sala.numero }}
                            </option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-4">
                        <label for="disponible" class="form-label">Disponibilidad (Doctores)</label>
                        <select class="form-select" id="disponible" name="disponible" onchange="this.form.submit()">
                            <option value="">Todos</option>
                            <option value="1">Solo disponibles</option>
                            <option value="0">No disponibles</option>
                        </select>
                    </div>
                    <div class="col-md-4 d-flex align-items-end">
                        <button type="submit" class="btn btn-primary me-2">
                            <i class="bi bi-funnel"></i> Aplicar Filtros
                        </button>
                        <a href="{{ url_for('consultas.global_view') }}" class="btn btn-secondary">
                            <i class="bi bi-x-circle"></i> Limpiar
                        </a>
                    </div>
                </form>
            </div>
        </div>

        <!-- Tabs -->
        <ul class="nav nav-tabs" id="consultasTabs" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="doctores-tab" data-bs-toggle="tab" data-bs-target="#doctores" type="button">
                    <i class="bi bi-person-badge"></i> Doctores ({{ doctores|length }})
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="pacientes-tab" data-bs-toggle="tab" data-bs-target="#pacientes" type="button">
                    <i class="bi bi-person"></i> Pacientes ({{ pacientes|length }})
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="camas-tab" data-bs-toggle="tab" data-bs-target="#camas" type="button">
                    <i class="bi bi-hospital"></i> Camas ({{ camas|length }})
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="trabajadores-tab" data-bs-toggle="tab" data-bs-target="#trabajadores" type="button">
                    <i class="bi bi-people"></i> Trabajadores Sociales ({{ trabajadores|length }})
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="visitas-tab" data-bs-toggle="tab" data-bs-target="#visitas" type="button">
                    <i class="bi bi-clipboard-check"></i> Visitas ({{ visitas|length }})
                </button>
            </li>
        </ul>

        <div class="tab-content" id="consultasTabContent">
            <!-- Tab Doctores -->
            <div class="tab-pane fade show active" id="doctores" role="tabpanel">
                <div class="table-responsive">
                    <table class="table table-striped table-hover">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Nombre</th>
                                <th>Especialidad</th>
                                <th>Sala</th>
                                <th>Disponible</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for doctor in doctores %}
                            <tr>
                                <td>{{ doctor.id_doctor }}</td>
                                <td>{{ doctor.nombre }}</td>
                                <td>{{ doctor.especialidad }}</td>
                                <td>Sala {{ doctor.sala.numero }}</td>
                                <td>
                                    {% if doctor.disponible %}
                                        <span class="badge bg-success">Disponible</span>
                                    {% else %}
                                        <span class="badge bg-danger">Ocupado</span>
                                    {% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Tab Pacientes -->
            <div class="tab-pane fade" id="pacientes" role="tabpanel">
                <div class="table-responsive">
                    <table class="table table-striped table-hover">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Nombre</th>
                                <th>Edad</th>
                                <th>Sexo</th>
                                <th>CURP</th>
                                <th>Teléfono</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for paciente in pacientes %}
                            <tr>
                                <td>{{ paciente.id_paciente }}</td>
                                <td>{{ paciente.nombre }}</td>
                                <td>{{ paciente.edad }}</td>
                                <td>{{ paciente.sexo }}</td>
                                <td>{{ paciente.curp or '-' }}</td>
                                <td>{{ paciente.telefono or '-' }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Tab Camas -->
            <div class="tab-pane fade" id="camas" role="tabpanel">
                <div class="table-responsive">
                    <table class="table table-striped table-hover">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Número</th>
                                <th>Sala</th>
                                <th>Estado</th>
                                <th>Paciente Actual</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for cama in camas %}
                            <tr>
                                <td>{{ cama.id_cama }}</td>
                                <td>Cama {{ cama.numero }}</td>
                                <td>Sala {{ cama.sala.numero }}</td>
                                <td>
                                    {% if cama.ocupada %}
                                        <span class="badge bg-danger">Ocupada</span>
                                    {% else %}
                                        <span class="badge bg-success">Disponible</span>
                                    {% endif %}
                                </td>
                                <td>{{ cama.paciente_actual.nombre if cama.paciente_actual else '-' }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Tab Trabajadores -->
            <div class="tab-pane fade" id="trabajadores" role="tabpanel">
                <div class="table-responsive">
                    <table class="table table-striped table-hover">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Nombre</th>
                                <th>Sala</th>
                                <th>Estado</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for trabajador in trabajadores %}
                            <tr>
                                <td>{{ trabajador.id_trabajador }}</td>
                                <td>{{ trabajador.nombre }}</td>
                                <td>Sala {{ trabajador.sala.numero }}</td>
                                <td>
                                    {% if trabajador.activo %}
                                        <span class="badge bg-success">Activo</span>
                                    {% else %}
                                        <span class="badge bg-secondary">Inactivo</span>
                                    {% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Tab Visitas -->
            <div class="tab-pane fade" id="visitas" role="tabpanel">
                <div class="table-responsive">
                    <table class="table table-striped table-hover">
                        <thead>
                            <tr>
                                <th>Folio</th>
                                <th>Paciente</th>
                                <th>Doctor</th>
                                <th>Cama</th>
                                <th>Sala</th>
                                <th>Estado</th>
                                <th>Hora</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for visita in visitas %}
                            <tr>
                                <td><strong>{{ visita.folio }}</strong></td>
                                <td>{{ visita.paciente.nombre }}</td>
                                <td>{{ visita.doctor.nombre }}</td>
                                <td>{{ visita.cama.numero }}</td>
                                <td>{{ visita.sala.numero }}</td>
                                <td>
                                    {% if visita.estado == 'activa' %}
                                        <span class="badge bg-warning text-dark">{{ visita.estado }}</span>
                                    {% elif visita.estado == 'completada' %}
                                        <span class="badge bg-success">{{ visita.estado }}</span>
                                    {% else %}
                                        <span class="badge bg-secondary">{{ visita.estado }}</span>
                                    {% endif %}
                                </td>
                                <td>{{ visita.timestamp.strftime('%d/%m/%Y %H:%M') }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}
